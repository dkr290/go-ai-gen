<div class="row">
  <div class="col-12">
    <div class="alert alert-danger">
      <h4><i class="bi bi-robot me-2"></i>Qwen Text-to-Image</h4>
      <p class="mb-0">
        Generate images using Qwen's advanced text-to-image capabilities.
      </p>
    </div>
  </div>
</div>

<div class="row mt-4">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Generation Parameters</h5>
      </div>
      <div class="card-body">
        <form
          hx-post="/api/qwen-t2i"
          hx-target="#result"
          hx-indicator="#loading"
        >
          <div class="mb-3">
            <label for="prompt" class="form-label">Prompt</label>
            <textarea
              class="form-control"
              id="prompt"
              name="prompt"
              rows="4"
              placeholder='["A beautiful sunset over mountains", "A futuristic city at night", "A cute cat playing with yarn"]'
              required
            ></textarea>
            <div class="form-text">
              Enter prompts as a JSON array. Qwen understands complex prompts
              with multiple elements.
            </div>
          </div>
          <div class="mb-3">
            <label for="suffix" class="form-label"
              >Image Enhancement suffux</label
            >
            <textarea
              class="form-control"
              id="suffix"
              name="suffix"
              rows="2"
              placeholder="Ultra HD, 4K, cinematic composition, masterpiece"
            ></textarea>
            <div class="form-text">
              Add quality enhancements to your prompt (comma-separated).
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="qwen_model" class="form-label">Qwen Model</label>
              <select class="form-select" id="qwen_model" name="qwen_model">
                <option value="Qwen/Qwen-Image" selected>
                  Qwen/Qwen-Image
                </option>
                <option value="qwen2.5-vl">Qwen2.5-VL</option>
                <option value="qwen-vl">Qwen-VL</option>
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label for="aspect_ratio" class="form-label">Aspect Ratio</label>
              <select class="form-select" id="aspect_ratio" name="aspect_ratio">
                <option value="1328x1328">Square 1:1-(1328, 1328)</option>
                <option value="1472x1140">Standard 4:3-(1472, 1140)</option>
                <option value="1664x928">Widescreen 16:9-(1664x928)</option>
                <option value="928x1664" selected>
                  Portrait 9x16-(928x1664)
                </option>

                <option value="1584x1056">Photo Big 3:2-(1584, 1056)</option>
                <option value="1140x1472">Photo 3:4-(1140, 1472)</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="steps" class="form-label">Steps</label>
              <input
                type="number"
                class="form-control"
                id="steps"
                name="steps"
                min="10"
                max="100"
                value="50"
              />
            </div>

            <div class="col-md-4 mb-3">
              <label for="guidance" class="form-label">Guidance Scale</label>
              <input
                type="range"
                class="form-range"
                id="guidance"
                name="guidance"
                min="1"
                max="15"
                step="0.5"
                value="4.0"
              />
              <div class="form-text text-center" id="guidance_value">4.0</div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-check form-switch mt-4">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="low_vram"
                  name="low_vram"
                  value="true"
                />
                <label class="form-check-label" for="low_vram">
                  Low VRAM Mode
                </label>
              </div>
              <div class="form-text">
                Enable for GPUs with less than 8GB VRAM
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="style_preset" class="form-label">Style Preset</label>
            <select class="form-select" id="style_preset" name="style_preset">
              <option value="none">No Style</option>
              <option value="photorealistic" selected>Photorealistic</option>
              <option value="anime">Anime</option>
              <option value="digital_art">Digital Art</option>
              <option value="painting">Painting</option>
              <option value="sketch">Sketch</option>
              <option value="watercolor">Watercolor</option>
              <option value="cyberpunk">Cyberpunk</option>
              <option value="fantasy">Fantasy</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="camera_shot" class="form-label">Camera Shot Type</label>
            <select class="form-select" id="camera_shot" name="camera_shot">
              <option value="">No specific shot (default)</option>
              <option value="front shot">Front Shot</option>
              <option value="wide angle shot">Wide Angle Shot</option>
              <option value="close-up shot">Close-up Shot</option>
              <option value="extreme close-up">Extreme Close-up</option>
              <option value="medium shot">Medium Shot</option>
              <option value="full shot">Full Shot</option>
              <option value="long shot">Long Shot</option>
              <option value="establishing shot">Establishing Shot</option>
              <option value="overhead shot">Overhead Shot</option>
              <option value="low angle shot">Low Angle Shot</option>
              <option value="high angle shot">High Angle Shot</option>
              <option value="dutch angle">Dutch Angle</option>
              <option value="point of view">Point of View (POV)</option>
              <option value="bird's eye view">Bird's Eye View</option>
              <option value="worm's eye view">Worm's Eye View</option>
            </select>
            <div class="form-text">
              Optional: Choose a camera shot type to control composition
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="seed" class="form-label">Seed</label>
              <input
                type="number"
                class="form-control"
                id="seed"
                name="seed"
                placeholder="Default 42"
                value="42"
              />
            </div>

            <div class="col-md-6 mb-3">
              <label for="batch_size" class="form-label">Batch Size</label>
              <select class="form-select" id="batch_size" name="batch_size">
                <option value="1">1 image</option>
                <option value="2" selected>2 images</option>
                <option value="4">4 images</option>
              </select>
            </div>
          </div>

          <div class="mb-3">
            <label for="negative_prompt" class="form-label"
              >Negative Prompt</label
            >
            <textarea
              class="form-control"
              id="negative_prompt"
              name="negative_prompt"
              rows="2"
              placeholder="What you don't want in the image..."
            ></textarea>
          </div>
          <div class="card mb-3">
            <div class="card-header">
              <h6 class="mb-0">Hugging Face Authentication (Optional)</h6>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label for="hf_token" class="form-label"
                  >Hugging Face Token</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="hf_token"
                  name="hf_token"
                  placeholder="hf_xxxxxxxxxxxxxxxxxxxx"
                  autocomplete="off"
                />
                <div class="form-text">
                  Required for gated/private models. Get your token from
                  <a
                    href="https://huggingface.co/settings/tokens"
                    target="_blank"
                    >Hugging Face Settings</a
                  >. Your token is only used for this request and not stored.
                </div>
              </div>
            </div>
          </div>

          <!-- LoRA Section -->
          <div class="card mb-3">
            <div class="card-header">
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="lora_enabled"
                  name="lora_enabled"
                  value="true"
                  onchange="toggleLoraFields()"
                />
                <label class="form-check-label" for="lora_enabled">
                  <strong>Enable LoRA</strong>
                </label>
              </div>
            </div>
            <div class="card-body" id="lora_fields" style="display: none">
              <div class="mb-3">
                <label for="lora_url" class="form-label">LoRA File URL</label>
                <input
                  type="url"
                  class="form-control"
                  id="lora_url"
                  name="lora_url"
                  placeholder="https://example.com/path/to/lora.safetensors"
                  disabled
                />
                <div class="form-text">
                  URL to download LoRA weights file (safetensors or .bin)
                </div>
              </div>
              <div class="mb-3">
                <label for="lora_adapter_name" class="form-label"
                  >Adapter Name</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="lora_adapter_name"
                  name="lora_adapter_name"
                  placeholder="lora"
                  value="lora"
                  disabled
                />
                <div class="form-text">
                  Name for the LoRA adapter (default: "lora")
                </div>
              </div>
            </div>
          </div>

          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button
              type="button"
              class="btn btn-secondary me-md-2"
              onclick="resetForm()"
            >
              <i class="bi bi-arrow-clockwise me-1"></i>Reset
            </button>
            <button type="submit" class="btn btn-danger">
              <i class="bi bi-robot me-1"></i>Generate Images
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Results</h5>
      </div>
      <div class="card-body">
        <div id="loading" class="text-center" style="display: none">
          <div class="spinner-border text-danger" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Generating images...</p>
        </div>
        <div id="result">
          <div class="text-center text-muted">
            <i class="bi bi-robot display-1"></i>
            <p class="mt-2">Your generated images will appear here</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-header">
        <h5 class="mb-0">Model Info</h5>
      </div>
      <div class="card-body">
        <p>
          <strong>Qwen</strong> is a multimodal AI model with advanced
          text-to-image capabilities, understanding complex prompts and
          generating high-quality images.
        </p>
        <ul class="list-unstyled">
          <li>
            <i class="bi bi-check-circle text-success me-2"></i>Multimodal
            understanding
          </li>
          <li>
            <i class="bi bi-check-circle text-success me-2"></i>Complex prompt
            handling
          </li>
          <li>
            <i class="bi bi-check-circle text-success me-2"></i>Multiple style
            options
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
  // Update guidance scale value display
  document.getElementById("guidance").addEventListener("input", function () {
    document.getElementById("guidance_value").textContent = this.value;
  });
  // Toggle LoRA fields
  function toggleLoraFields() {
    const loraEnabled = document.getElementById("lora_enabled").checked;
    const loraFields = document.getElementById("lora_fields");
    const loraUrl = document.getElementById("lora_url");
    const loraAdapter = document.getElementById("lora_adapter_name");

    if (loraEnabled) {
      loraFields.style.display = "block";
      loraUrl.disabled = false;
      loraAdapter.disabled = false;
      loraUrl.required = true;
    } else {
      loraFields.style.display = "none";
      loraUrl.disabled = true;
      loraAdapter.disabled = true;
      loraUrl.required = false;
    }
  }

  // Initialize on page load
  document.addEventListener("DOMContentLoaded", toggleLoraFields);

  function resetForm() {
    document.querySelector("form").reset();
    document.getElementById("guidance_value").textContent = "4.0";
    document.getElementById("result").innerHTML = `
            <div class="text-center text-muted">
                <i class="bi bi-robot display-1"></i>
                <p class="mt-2">Your generated images will appear here</p>
            </div>
        `;
    toggleLoraFields();
  }
  document.addEventListener("htmx:afterSwap", function (event) {
    if (event.detail.target.id === "result") {
      const response = event.detail.xhr.response;
      try {
        const data = JSON.parse(response);
        if (
          data.success &&
          data.data.image_urls &&
          data.data.image_urls.length > 0
        ) {
          let imagesHTML = '<div class="row">';
          data.data.image_urls.forEach(function (url, index) {
            imagesHTML += `
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <img src="${url}" class="card-img-top" alt="Generated image ${index + 1}">
                                    <div class="card-body">
                                        <p class="card-text text-muted small">Image ${index + 1}</p>
                                    </div>
                                </div>
                            </div>
                        `;
          });
          imagesHTML += "</div>";
          document.getElementById("result").innerHTML = imagesHTML;
        }
      } catch (e) {
        console.error("Failed to parse response:", e);
      }
    }
  });
</script>
