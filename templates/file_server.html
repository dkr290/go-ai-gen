<div class="row">
  <div class="col-12">
    <div class="alert alert-info">
      <h4><i class="bi bi-folder me-2"></i>File Server</h4>
      <p class="mb-0">
        Browse and download generated images from the downloads/generated
        directory.
      </p>
    </div>
  </div>
</div>

<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h5 class="mb-0">Generated Images</h5>
        <div>
          <button
            class="btn btn-sm btn-outline-primary me-2"
            onclick="selectAll()"
          >
            <i class="bi bi-check-square me-1"></i>Select All
          </button>
          <button
            class="btn btn-sm btn-danger"
            onclick="downloadSelected()"
            id="downloadBtn"
            disabled
          >
            <i class="bi bi-download me-1"></i>Download Selected
          </button>
        </div>
      </div>
      <div class="card-body">
        <div id="loading" class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">Loading images...</p>
        </div>
        <div id="imageGrid" class="row" style="display: none">
          <!-- Images will be loaded here -->
        </div>
        <div id="noImages" class="text-center text-muted" style="display: none">
          <i class="bi bi-folder-x display-1"></i>
          <p class="mt-2">No images found in downloads/generated directory.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Load images on page load
  document.addEventListener("DOMContentLoaded", function () {
    loadImages();
  });

  function loadImages() {
    fetch("/api/file-server/list")
      .then((response) => response.json())
      .then((data) => {
        document.getElementById("loading").style.display = "none";

        if (data.success && data.files && data.files.length > 0) {
          const imageGrid = document.getElementById("imageGrid");
          imageGrid.innerHTML = "";

          data.files.forEach((file, index) => {
            const col = document.createElement("div");
            col.className = "col-md-4 col-lg-3 mb-4";
            col.innerHTML = `
              <div class="card h-100">
                <div class="card-img-top position-relative" style="height: 200px; overflow: hidden;">
                  <img src="${file.url}" class="w-100 h-100" style="object-fit: cover;" alt="${file.name}">
                  <div class="position-absolute top-0 end-0 m-2">
                    <input type="checkbox" class="form-check-input image-checkbox" data-url="${file.url}" data-name="${file.name}" onchange="updateDownloadButton()">
                  </div>
                </div>
                <div class="card-body">
                  <h6 class="card-title text-truncate" title="${file.name}">${file.name}</h6>
                  <p class="card-text small text-muted">
                    <i class="bi bi-calendar me-1"></i>${file.modified}
                    <br>
                    <i class="bi bi-file-earmark me-1"></i>${file.size}
                  </p>
                  <div class="d-grid gap-2">
                    <a href="${file.url}" class="btn btn-sm btn-outline-primary" download="${file.name}">
                      <i class="bi bi-download me-1"></i>Download
                    </a>
                  </div>
                </div>
              </div>
            `;
            imageGrid.appendChild(col);
          });

          imageGrid.style.display = "flex";
        } else {
          document.getElementById("noImages").style.display = "block";
        }
      })
      .catch((error) => {
        console.error("Error loading images:", error);
        document.getElementById("loading").style.display = "none";
        document.getElementById("noImages").innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Error loading images:</strong> ${error.message}
          </div>
        `;
        document.getElementById("noImages").style.display = "block";
      });
  }

  function selectAll() {
    const checkboxes = document.querySelectorAll(".image-checkbox");
    const allChecked = Array.from(checkboxes).every((cb) => cb.checked);

    checkboxes.forEach((cb) => {
      cb.checked = !allChecked;
    });

    updateDownloadButton();
  }

  function updateDownloadButton() {
    const checkboxes = document.querySelectorAll(".image-checkbox");
    const selectedCount = Array.from(checkboxes).filter(
      (cb) => cb.checked,
    ).length;
    const downloadBtn = document.getElementById("downloadBtn");

    if (selectedCount > 0) {
      downloadBtn.disabled = false;
      downloadBtn.innerHTML = `<i class="bi bi-download me-1"></i>Download Selected (${selectedCount})`;
    } else {
      downloadBtn.disabled = true;
      downloadBtn.innerHTML = `<i class="bi bi-download me-1"></i>Download Selected`;
    }
  }

  function downloadSelected() {
    const checkboxes = document.querySelectorAll(".image-checkbox:checked");
    if (checkboxes.length === 0) return;

    // For single file, just trigger download
    if (checkboxes.length === 1) {
      const url = checkboxes[0].dataset.url;
      const name = checkboxes[0].dataset.name;
      const link = document.createElement("a");
      link.href = url;
      link.download = name;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      return;
    }

    // For multiple files, we need a server endpoint to create a zip
    alert(
      "Multiple file download would require server-side zip creation. For now, please download files individually.",
    );
  }
</script>

<style>
  .image-checkbox {
    width: 1.2em;
    height: 1.2em;
    cursor: pointer;
  }

  .card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
</style>
